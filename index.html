<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transportkostenkalkulation & Angebotserstellung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #2c5f2d;
            text-align: center;
            border-bottom: 3px solid #2c5f2d;
            padding-bottom: 10px;
        }
        .main-content {
            display: flex;
            gap: 30px;
        }
        .calculator-section {
            flex: 1;
            min-width: 500px;
        }
        .overview-section {
            flex: 1;
            min-width: 400px;
        }
        .transport-info {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .transport-info input, .transport-info textarea, .transport-info select {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .transport-info textarea {
            height: 60px;
            resize: vertical;
        }
        .route-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .route-info-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        .cost-section {
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .section-header {
            background-color: #2c5f2d;
            color: white;
            padding: 12px;
            font-weight: bold;
            font-size: 18px;
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background-color: #fafafa;
        }
        .cost-item:last-child {
            border-bottom: none;
        }
        .cost-item label {
            flex: 1;
            font-weight: 500;
        }
        .cost-item input {
            width: 120px;
            padding: 6px 10px;
            text-align: right;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .currency-select {
            width: 70px;
            margin-left: 5px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .subtotal {
            background-color: #e8f5e8;
            font-weight: bold;
            color: #2c5f2d;
        }
        .total {
            background-color: #2c5f2d;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        .selling-price {
            background-color: #28a745;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        .exchange-rate {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
        }
        .exchange-rate input {
            width: 100px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 5px;
        }
        .buttons {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background-color: #2c5f2d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
        }
        button:hover {
            background-color: #1e4220;
        }
        .save-button {
            background-color: #007bff;
        }
        .save-button:hover {
            background-color: #0056b3;
        }
        .offer-button {
            background-color: #28a745;
        }
        .offer-button:hover {
            background-color: #1e7e34;
        }
        .overview-header {
            background-color: #6c757d;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .transport-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .transport-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
        }
        .transport-item:last-child {
            border-bottom: none;
        }
        .transport-item h4 {
            margin: 0 0 10px 0;
            color: #2c5f2d;
        }
        .transport-costs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        .transport-total {
            font-weight: bold;
            color: #dc3545;
            margin-top: 10px;
            text-align: right;
        }
        .grand-total {
            background-color: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
        }
        .delete-button {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            float: right;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        .edit-button {
            background-color: #ffc107;
            color: #000;
            padding: 5px 10px;
            font-size: 12px;
            float: right;
            margin-right: 5px;
        }
        .edit-button:hover {
            background-color: #e0a800;
        }
        .offer-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .offer-preview {
            border: 1px solid #ddd;
            padding: 20px;
            background-color: #f9f9f9;
            font-family: Arial, sans-serif;
            white-space: pre-line;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .offer-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .offer-form input, .offer-form textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .offer-options {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ddd;
        }
        .offer-options h4 {
            margin-top: 0;
            color: #2c5f2d;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .calculator-section, .overview-section {
                min-width: auto;
            }
            .offer-form, .checkbox-group {
                grid-template-columns: 1fr;
            }
            .route-info-3 {
                grid-template-columns: 1fr;
            }
        }
        @media print {
            .buttons, .close, .modal-overlay {
                display: none !important;
            }
            .modal-content {
                margin: 0;
                width: 100%;
                max-width: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transportkostenkalkulation & Angebotserstellung</h1>
        
        <div class="main-content">
            <!-- Kalkulationsbereich -->
            <div class="calculator-section">
                <div class="transport-info">
                    <label for="transport-name"><strong>Transportname/Bezeichnung:</strong></label>
                    <input type="text" id="transport-name" placeholder="z.B. DGR-Sendung ex Affalterbach → Englewood (CO)">
                    
                    <div class="route-info">
                        <div>
                            <label><strong>Gruppe:</strong></label>
                            <select id="transport-group">
                                <option value="Hintransport">Hintransport</option>
                                <option value="Innertransport">Innertransport</option>
                                <option value="Rücktransport">Rücktransport</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div>
                            <label><strong>Priorität:</strong></label>
                            <input type="number" id="transport-priority" value="1" min="1" max="99" placeholder="1">
                        </div>
                    </div>
                    
                    <label><strong>Sendungsdetails:</strong></label>
                    <textarea id="shipment-details" placeholder="z.B. 1 Packstück / 140 × 70 × 158 cm / 260 kg / UN3363, Klasse 9"></textarea>
                    
                    <div class="route-info">
                        <div>
                            <label><strong>Von:</strong></label>
                            <input type="text" id="origin" placeholder="z.B. Affalterbach">
                        </div>
                        <div>
                            <label><strong>Nach:</strong></label>
                            <input type="text" id="destination" placeholder="z.B. Englewood (CO)">
                        </div>
                    </div>
                    
                    <div class="route-info-3">
                        <div>
                            <label><strong>Abholung:</strong></label>
                            <input type="date" id="pickup-date">
                        </div>
                        <div>
                            <label><strong>Abholzeit:</strong></label>
                            <input type="time" id="pickup-time" value="11:00">
                        </div>
                        <div>
                            <label><strong>Geplanter Flug:</strong></label>
                            <input type="date" id="flight-date">
                        </div>
                    </div>
                    
                    <div class="route-info">
                        <div>
                            <label><strong>Zustellung:</strong></label>
                            <input type="date" id="delivery-date">
                        </div>
                        <div>
                            <label><strong>Zustellzeit (optional):</strong></label>
                            <input type="time" id="delivery-time">
                        </div>
                    </div>
                </div>

                <!-- Wechselkurs EUR -> USD -->
                <div class="exchange-rate">
                    <strong>Wechselkurs EUR → USD:</strong>
                    <input type="number" step="0.0001" id="exchange-rate" value="1.18" oninput="calculateTotals()">
                    <span>USD/EUR</span>
                </div>

                <!-- Vorlaufkosten -->
                <div class="cost-section">
                    <div class="section-header">Vorlaufkosten</div>
                    
                    <div class="cost-item">
                        <label>Vorlauf</label>
                        <input type="number" step="0.01" id="vorlauf" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option>EUR</option>
                            <option>USD</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>Handling</label>
                        <input type="number" step="0.01" id="handling1" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option>EUR</option>
                            <option>USD</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>X-Ray</label>
                        <input type="number" step="0.01" id="xray" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option>EUR</option>
                            <option>USD</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>Luftfracht</label>
                        <input type="number" step="0.01" id="luftfracht" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option>EUR</option>
                            <option>USD</option>
                        </select>
                    </div>
                    
                    <div class="cost-item subtotal">
                        <label>Zwischensumme Vorlaufkosten</label>
                        <span id="subtotal-vorlauf">0,00 USD</span>
                    </div>
                </div>

                <!-- Nachlaufkosten -->
                <div class="cost-section">
                    <div class="section-header">Nachlaufkosten</div>
                    
                    <div class="cost-item">
                        <label>Verzollung</label>
                        <input type="number" step="0.01" id="verzollung" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option selected>USD</option>
                            <option>EUR</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>ISF</label>
                        <input type="number" step="0.01" id="isf" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option selected>USD</option>
                            <option>EUR</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>Trucking</label>
                        <input type="number" step="0.01" id="trucking" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option selected>USD</option>
                            <option>EUR</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>Handling</label>
                        <input type="number" step="0.01" id="handling2" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option selected>USD</option>
                            <option>EUR</option>
                        </select>
                    </div>
                    
                    <div class="cost-item">
                        <label>Supervising</label>
                        <input type="number" step="0.01" id="supervising" oninput="calculateTotals()">
                        <select class="currency-select" onchange="calculateTotals()">
                            <option selected>USD</option>
                            <option>EUR</option>
                        </select>
                    </div>
                    
                    <div class="cost-item subtotal">
                        <label>Zwischensumme Nachlaufkosten</label>
                        <span id="subtotal-nachlauf">0,00 USD</span>
                    </div>
                </div>

                <!-- EK/VK-Bereich -->
                <div class="cost-section">
                    <div class="cost-item total">
                        <label>Einkaufspreis (EK)</label>
                        <span id="total-final-eur">0,00 EUR</span>
                    </div>
                    
                    <div class="cost-item selling-price">
                        <label>Verkaufspreis (VK)</label>
                        <input type="number" step="0.01" id="selling-price-input" oninput="calculateProfit()" style="background: white; color: black;">
                        <span style="padding: 6px 10px; background-color: #e9ecef; border: 1px solid #ddd; border-radius: 4px; width: 70px; text-align: center; margin-left: 5px;">EUR</span>
                    </div>
                    
                    <div class="cost-item subtotal">
                        <label>Gewinn</label>
                        <span id="profit-amount">0,00 EUR</span>
                    </div>
                </div>

                <div class="buttons">
                    <button class="save-button" onclick="saveTransport()">Transport speichern</button>
                    <button class="offer-button" onclick="generateOffer()">Angebot erstellen</button>
                    <button onclick="resetForm()">Zurücksetzen</button>
                    <button onclick="exportAllToCSV()">Alle als CSV</button>
                </div>
            </div>

            <!-- Übersichtsbereich -->
            <div class="overview-section">
                <div class="overview-header">
                    <h2>Gespeicherte Transporte</h2>
                </div>
                
                <div class="transport-list" id="transport-list">
                    <div style="padding: 20px; text-align: center; color: #666;">
                        Noch keine Transporte gespeichert
                    </div>
                </div>

                <div class="grand-total" id="grand-total" style="display: none;">
                    GESAMTKOSTEN ALLER TRANSPORTE<br>
                    <span id="grand-total-amount">0,00 USD</span><br>
                    <small id="grand-total-eur">(0,00 EUR)</small>
                </div>

                <div class="buttons" style="margin-top: 20px;">
                    <button onclick="generateGroupedOffer()" class="offer-button">Gruppiertes Angebot (nur Text)</button>
                    <button onclick="clearAllTransports()" style="background-color: #dc3545;">Alle löschen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Angebot Modal -->
    <div id="offerModal" class="offer-modal">
        <div class="modal-content">
            <span class="close" onclick="closeOfferModal()">&times;</span>
            <h2>Angebot erstellen</h2>
            
            <div class="offer-form">
                <input type="text" id="customer-name" placeholder="Kundenname (z.B. Andreas)" class="full-width">
                <input type="text" id="offer-from" placeholder="Von" value="">
                <input type="text" id="offer-to" placeholder="Nach" value="">
                <input type="text" id="offer-shipment" placeholder="Sendungsdetails" class="full-width" value="">
                <input type="date" id="offer-pickup" placeholder="Abholung">
                <input type="time" id="offer-pickup-time" value="11:00">
                <input type="date" id="offer-flight" placeholder="Geplanter Flug">
                <input type="date" id="offer-delivery" placeholder="Zustellung">
                <input type="time" id="offer-delivery-time" placeholder="Zustellzeit (optional)">
            </div>

            <div class="offer-options">
                <h4>Anzeige-Optionen</h4>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="show-flight-date" checked> Flugdatum anzeigen</label>
                    <label><input type="checkbox" id="show-shipment-details" checked> Sendungsdetails anzeigen</label>
                    <label><input type="checkbox" id="show-pickup-times" checked> Abholzeiten anzeigen</label>
                    <label><input type="checkbox" id="show-delivery-times"> Zustellzeiten anzeigen</label>
                    <label><input type="checkbox" id="show-group-totals" checked> Gesamtkosten pro Gruppe</label>
                    <label><input type="checkbox" id="show-usd-prices"> USD-Preise zusätzlich anzeigen</label>
                </div>
            </div>
            
            <div class="buttons">
                <button onclick="updateOfferPreview()" style="background-color: #17a2b8;">Vorschau aktualisieren</button>
                <button onclick="copyToClipboard()" style="background-color: #28a745;">Für Outlook kopieren</button>
                <button onclick="printOffer()" style="background-color: #6c757d;">Drucken</button>
            </div>
            
            <div class="offer-preview" id="offer-preview">
                Hier erscheint die Angebot-Vorschau...
            </div>
        </div>
    </div>

    <script>
        let savedTransports = JSON.parse(localStorage.getItem('savedTransports')) || [];
        let editingIndex = -1;

        function calculateTotals() {
            const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || 1.18;
            
            // Vorlaufkosten sammeln (mit Währungsauswahl)
            const vorlaufKosten = {
                vorlauf: { value: parseFloat(document.getElementById('vorlauf').value) || 0, currency: document.querySelectorAll('.currency-select')[0].value },
                handling1: { value: parseFloat(document.getElementById('handling1').value) || 0, currency: document.querySelectorAll('.currency-select')[1].value },
                xray: { value: parseFloat(document.getElementById('xray').value) || 0, currency: document.querySelectorAll('.currency-select')[2].value },
                luftfracht: { value: parseFloat(document.getElementById('luftfracht').value) || 0, currency: document.querySelectorAll('.currency-select')[3].value }
            };

            // Nachlaufkosten sammeln (mit Währungsauswahl)
            const nachlaufKosten = {
                verzollung: { value: parseFloat(document.getElementById('verzollung').value) || 0, currency: document.querySelectorAll('.currency-select')[4].value },
                isf: { value: parseFloat(document.getElementById('isf').value) || 0, currency: document.querySelectorAll('.currency-select')[5].value },
                trucking: { value: parseFloat(document.getElementById('trucking').value) || 0, currency: document.querySelectorAll('.currency-select')[6].value },
                handling2: { value: parseFloat(document.getElementById('handling2').value) || 0, currency: document.querySelectorAll('.currency-select')[7].value },
                supervising: { value: parseFloat(document.getElementById('supervising').value) || 0, currency: document.querySelectorAll('.currency-select')[8].value }
            };

            // Vorlaufkosten in USD umrechnen
            let subtotalVorlaufUSD = 0;
            Object.values(vorlaufKosten).forEach(cost => {
                if (cost.currency === 'EUR') {
                    subtotalVorlaufUSD += cost.value * exchangeRate;
                } else {
                    subtotalVorlaufUSD += cost.value;
                }
            });

            // Nachlaufkosten in USD umrechnen
            let subtotalNachlaufUSD = 0;
            Object.values(nachlaufKosten).forEach(cost => {
                if (cost.currency === 'EUR') {
                    subtotalNachlaufUSD += cost.value * exchangeRate;
                } else {
                    subtotalNachlaufUSD += cost.value;
                }
            });

            const totalUSD = subtotalVorlaufUSD + subtotalNachlaufUSD;
            const totalEUR = totalUSD / exchangeRate;
            
            // Anzeige aktualisieren
            document.getElementById('subtotal-vorlauf').textContent = subtotalVorlaufUSD.toFixed(2) + ' USD';
            document.getElementById('subtotal-nachlauf').textContent = subtotalNachlaufUSD.toFixed(2) + ' USD';
            document.getElementById('total-final-eur').textContent = totalEUR.toFixed(2) + ' EUR';
            
            // Gewinn berechnen wenn VK eingegeben
            calculateProfit();
        }

        function calculateProfit() {
            const sellingPrice = parseFloat(document.getElementById('selling-price-input').value) || 0;
            const buyingPrice = parseFloat(document.getElementById('total-final-eur').textContent.replace(' EUR', '').replace(',', '.')) || 0;
            const profit = sellingPrice - buyingPrice;
            
            document.getElementById('profit-amount').textContent = profit.toFixed(2) + ' EUR';
        }

        function saveTransport() {
            const transportName = document.getElementById('transport-name').value || `Transport ${savedTransports.length + 1}`;
            const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || 1.18;
            
            const transport = {
                name: transportName,
                group: document.getElementById('transport-group').value,
                priority: parseInt(document.getElementById('transport-priority').value) || 1,
                exchangeRate: exchangeRate,
                shipmentDetails: document.getElementById('shipment-details').value || '',
                origin: document.getElementById('origin').value || '',
                destination: document.getElementById('destination').value || '',
                pickupDate: document.getElementById('pickup-date').value || '',
                pickupTime: document.getElementById('pickup-time').value || '11:00',
                flightDate: document.getElementById('flight-date').value || '',
                deliveryDate: document.getElementById('delivery-date').value || '',
                deliveryTime: document.getElementById('delivery-time').value || '',
                vorlaufkosten: {
                    vorlauf: { value: parseFloat(document.getElementById('vorlauf').value) || 0, currency: document.querySelectorAll('.currency-select')[0].value },
                    handling1: { value: parseFloat(document.getElementById('handling1').value) || 0, currency: document.querySelectorAll('.currency-select')[1].value },
                    xray: { value: parseFloat(document.getElementById('xray').value) || 0, currency: document.querySelectorAll('.currency-select')[2].value },
                    luftfracht: { value: parseFloat(document.getElementById('luftfracht').value) || 0, currency: document.querySelectorAll('.currency-select')[3].value }
                },
                nachlaufkosten: {
                    verzollung: { value: parseFloat(document.getElementById('verzollung').value) || 0, currency: document.querySelectorAll('.currency-select')[4].value },
                    isf: { value: parseFloat(document.getElementById('isf').value) || 0, currency: document.querySelectorAll('.currency-select')[5].value },
                    trucking: { value: parseFloat(document.getElementById('trucking').value) || 0, currency: document.querySelectorAll('.currency-select')[6].value },
                    handling2: { value: parseFloat(document.getElementById('handling2').value) || 0, currency: document.querySelectorAll('.currency-select')[7].value },
                    supervising: { value: parseFloat(document.getElementById('supervising').value) || 0, currency: document.querySelectorAll('.currency-select')[8].value }
                },
                timestamp: new Date().toLocaleString('de-DE')
            };

            // Berechne Gesamtkosten in USD und EUR
            let totalUSD = 0;
            Object.values(transport.vorlaufkosten).forEach(cost => {
                if (cost.currency === 'EUR') {
                    totalUSD += cost.value * exchangeRate;
                } else {
                    totalUSD += cost.value;
                }
            });
            Object.values(transport.nachlaufkosten).forEach(cost => {
                if (cost.currency === 'EUR') {
                    totalUSD += cost.value * exchangeRate;
                } else {
                    totalUSD += cost.value;
                }
            });
            
            transport.totalUSD = totalUSD;
            transport.totalEUR = totalUSD / exchangeRate;
            transport.sellingPriceEUR = parseFloat(document.getElementById('selling-price-input').value) || transport.totalEUR;
            transport.profitEUR = transport.sellingPriceEUR - transport.totalEUR;

            if (editingIndex >= 0) {
                savedTransports[editingIndex] = transport;
                editingIndex = -1;
                document.querySelector('.save-button').textContent = 'Transport speichern';
            } else {
                savedTransports.push(transport);
            }

            localStorage.setItem('savedTransports', JSON.stringify(savedTransports));
            displayTransports();
            resetForm();
            
            alert(`Transport "${transportName}" wurde gespeichert!`);
        }

        function displayTransports() {
            const listContainer = document.getElementById('transport-list');
            
            if (savedTransports.length === 0) {
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Noch keine Transporte gespeichert</div>';
                document.getElementById('grand-total').style.display = 'none';
                return;
            }

            let html = '';
            let grandTotalUSD = 0;
            let grandTotalVKEUR = 0;

            savedTransports.forEach((transport, index) => {
                grandTotalUSD += transport.totalUSD;
                grandTotalVKEUR += transport.sellingPriceEUR || transport.totalEUR;
                
                html += `
                    <div class="transport-item">
                        <button class="delete-button" onclick="deleteTransport(${index})">❌</button>
                        <button class="edit-button" onclick="editTransport(${index})">✏️</button>
                        <h4>${transport.name} (${transport.group || 'Sonstiges'})</h4>
                        <small>Gespeichert: ${transport.timestamp}</small><br>
                        <small><strong>Route:</strong> ${transport.origin} → ${transport.destination}</small>
                        <div class="transport-total">
                            <strong>EK: ${transport.totalEUR.toFixed(2)} EUR | VK: ${(transport.sellingPriceEUR || transport.totalEUR).toFixed(2)} EUR</strong><br>
                            <strong>Gewinn: ${((transport.sellingPriceEUR || transport.totalEUR) - transport.totalEUR).toFixed(2)} EUR</strong>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            
            // Gesamtsumme anzeigen
            const grandTotalEUR = grandTotalUSD / (savedTransports[0]?.exchangeRate || 1.18);
            document.getElementById('grand-total-amount').textContent = `EK: ${grandTotalEUR.toFixed(2)} EUR | VK: ${grandTotalVKEUR.toFixed(2)} EUR`;
            document.getElementById('grand-total-eur').textContent = `Gewinn: ${(grandTotalVKEUR - grandTotalEUR).toFixed(2)} EUR`;
            document.getElementById('grand-total').style.display = 'block';
        }

        function generateOffer() {
            const modal = document.getElementById('offerModal');
            
            // Formular mit aktuellen Daten füllen
            document.getElementById('offer-from').value = document.getElementById('origin').value;
            document.getElementById('offer-to').value = document.getElementById('destination').value;
            document.getElementById('offer-shipment').value = document.getElementById('shipment-details').value;
            document.getElementById('offer-pickup').value = document.getElementById('pickup-date').value;
            document.getElementById('offer-pickup-time').value = document.getElementById('pickup-time').value;
            document.getElementById('offer-flight').value = document.getElementById('flight-date').value;
            document.getElementById('offer-delivery').value = document.getElementById('delivery-date').value;
            document.getElementById('offer-delivery-time').value = document.getElementById('delivery-time').value;
            
            modal.style.display = 'block';
            updateOfferPreview();
        }

        function generateGroupedOffer() {
            if (savedTransports.length === 0) {
                alert('Keine Transporte gespeichert!');
                return;
            }
            
            // Transporte nach Gruppe und Priorität sortieren
            const sortedTransports = [...savedTransports].sort((a, b) => {
                const groupOrder = ['Hintransport', 'Innertransport', 'Rücktransport', 'Sonstiges'];
                const groupA = groupOrder.indexOf(a.group) !== -1 ? groupOrder.indexOf(a.group) : 999;
                const groupB = groupOrder.indexOf(b.group) !== -1 ? groupOrder.indexOf(b.group) : 999;
                
                if (groupA !== groupB) return groupA - groupB;
                return (a.priority || 1) - (b.priority || 1);
            });
            
            // Gruppieren
            const groupedTransports = {};
            sortedTransports.forEach(transport => {
                const group = transport.group || 'Sonstiges';
                if (!groupedTransports[group]) {
                    groupedTransports[group] = [];
                }
                groupedTransports[group].push(transport);
            });
            
            const customerName = prompt('Kundenname:', 'Andreas') || 'Andreas';
            const exchangeRate = savedTransports[0]?.exchangeRate || 1.18;
            
            let offerText = `Sehr geehrter Herr ${customerName},

aufgrund aktueller Marktgegebenheiten, Umrechnungskurs EUR/USD ${exchangeRate}, und bei freier Airline-/Routenwahl können wir Ihnen folgende Preise anbieten:

`;

            let counter = 1;
            const groupTotals = {};
            
            Object.keys(groupedTransports).forEach(group => {
                const transports = groupedTransports[group];
                let groupTotalEUR = 0;
                let groupTotalUSD = 0;
                
                transports.forEach((transport) => {
                    const pickupDate = formatGermanDate(transport.pickupDate);
                    const deliveryDate = formatGermanDate(transport.deliveryDate);
                    const pickupTime = transport.pickupTime || '11:00';
                    const deliveryTimeText = transport.deliveryTime ? `, ${transport.deliveryTime} Uhr` : '';
                    const flightText = transport.flightDate ? `\n   Geplanter Flug: ${formatGermanDate(transport.flightDate)}` : '';
                    
                    const sellingPriceEUR = transport.sellingPriceEUR || transport.totalEUR;
                    const sellingPriceUSD = sellingPriceEUR * exchangeRate;
                    
                    let priceText = `EUR ${Math.round(sellingPriceEUR).toLocaleString('de-DE')}`;
                    // USD zusätzlich anzeigen wenn ursprünglich USD kalkuliert wurde
                    if (hasUSDCosts(transport)) {
                        priceText += ` (USD ${Math.round(sellingPriceUSD).toLocaleString('de-DE')})`;
                    }
                    
                    offerText += `${counter}. ${group.toUpperCase()}\n`;
                    if (transport.shipmentDetails) {
                        offerText += `   Sendung: ${transport.shipmentDetails}\n`;
                    }
                    offerText += `   Route: ${transport.origin} → ${transport.destination}\n`;
                    offerText += `   Preis: ${priceText}\n`;
                    offerText += `   Abholung: ${pickupDate}, ${pickupTime} Uhr${flightText}\n`;
                    offerText += `   Zustellung: am ${deliveryDate}${deliveryTimeText}\n\n`;
                    
                    counter++;
                    groupTotalEUR += sellingPriceEUR;
                    groupTotalUSD += sellingPriceUSD;
                });
                
                groupTotals[group] = { eur: groupTotalEUR, usd: groupTotalUSD };
            });
            
            // Gesamtpreise nach Gruppen
            const groupNames = Object.keys(groupTotals);
            if (groupNames.length > 1) {
                const totalEUR = Object.values(groupTotals).reduce((sum, group) => sum + group.eur, 0);
                const totalUSD = Object.values(groupTotals).reduce((sum, group) => sum + group.usd, 0);
                
                let priceText = `EUR ${Math.round(totalEUR).toLocaleString('de-DE')}`;
                if (Object.values(savedTransports).some(t => hasUSDCosts(t))) {
                    priceText += ` (USD ${Math.round(totalUSD).toLocaleString('de-DE')})`;
                }
                
                offerText += `GESAMTPREIS ${groupNames.join(', ').toUpperCase()}: ${priceText}`;
            }
            
            // Neues Fenster mit nur Text
            const textWindow = window.open('', '_blank');
            textWindow.document.write(`
                <html>
                <head>
                    <title>Angebot für ${customerName}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 40px; 
                            line-height: 1.8;
                        }
                        .offer-text { 
                            white-space: pre-line; 
                            border: 1px solid #ddd; 
                            padding: 30px; 
                            background: #fafafa;
                            font-size: 14px;
                        }
                        .copy-button {
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            font-size: 16px;
                            cursor: pointer;
                            margin-bottom: 20px;
                            border-radius: 5px;
                        }
                        .copy-button:hover {
                            background: #0056b3;
                        }
                    </style>
                </head>
                <body>
                    <button class="copy-button" onclick="copyText()">Text für Outlook kopieren</button>
                    <div class="offer-text" id="offerText">${offerText.replace(/\n/g, '<br>')}</div>
                    
                    <script>
                        function copyText() {
                            const text = \`${offerText}\`;
                            
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = text.replace(/\\n/g, '<br>');
                            document.body.appendChild(tempDiv);
                            
                            const range = document.createRange();
                            range.selectNode(tempDiv);
                            window.getSelection().removeAllRanges();
                            window.getSelection().addRange(range);
                            document.execCommand('copy');
                            window.getSelection().removeAllRanges();
                            
                            document.body.removeChild(tempDiv);
                            alert('Angebot wurde für Outlook kopiert!');
                        }
                    <\/script>
                </body>
                </html>
            `);
        }

        function hasUSDCosts(transport) {
            const allCosts = {...transport.vorlaufkosten, ...transport.nachlaufkosten};
            return Object.values(allCosts).some(cost => cost.currency === 'USD' && cost.value > 0);
        }

        function updateOfferPreview() {
            const customerName = document.getElementById('customer-name').value || 'Andreas';
            const exchangeRate = document.getElementById('exchange-rate').value;
            const transportName = document.getElementById('transport-name').value || 'Transport';
            const shipmentDetails = document.getElementById('offer-shipment').value || '';
            const origin = document.getElementById('offer-from').value || '';
            const destination = document.getElementById('offer-to').value || '';
            const pickupDate = formatGermanDate(document.getElementById('offer-pickup').value);
            const pickupTime = document.getElementById('offer-pickup-time').value || '11:00';
            const flightDate = formatGermanDate(document.getElementById('offer-flight').value);
            const deliveryDate = formatGermanDate(document.getElementById('offer-delivery').value);
            const deliveryTime = document.getElementById('offer-delivery-time').value;
            
            const sellingPriceEUR = parseFloat(document.getElementById('selling-price-input').value) || parseFloat(document.getElementById('total-final-eur').textContent.replace(' EUR', '').replace(',', '.'));
            
            // Checkboxen auslesen
            const showFlightDate = document.getElementById('show-flight-date').checked;
            const showShipmentDetails = document.getElementById('show-shipment-details').checked;
            const showPickupTimes = document.getElementById('show-pickup-times').checked;
            const showDeliveryTimes = document.getElementById('show-delivery-times').checked;
            const showUSDPrices = document.getElementById('show-usd-prices').checked;

            let offerText = `Sehr geehrter Herr ${customerName},

aufgrund aktueller Marktgegebenheiten, Umrechnungskurs EUR/USD ${exchangeRate}, und bei freier Airline-/Routenwahl können wir Ihnen folgende Preise anbieten:

1. ${transportName.toUpperCase()}`;

            if (showShipmentDetails && shipmentDetails) {
                offerText += `\n   Sendung: ${shipmentDetails}`;
            }
            
            offerText += `\n   Route: ${origin} → ${destination}`;
            
            let priceText = `EUR ${Math.round(sellingPriceEUR).toLocaleString('de-DE')}`;
            if (showUSDPrices) {
                const sellingPriceUSD = sellingPriceEUR * parseFloat(exchangeRate);
                priceText += ` (USD ${Math.round(sellingPriceUSD).toLocaleString('de-DE')})`;
            }
            offerText += `\n   Preis: ${priceText}`;
            
            if (showPickupTimes && pickupDate) {
                offerText += `\n   Abholung: ${pickupDate}, ${pickupTime} Uhr`;
            }
            
            if (showFlightDate && flightDate) {
                offerText += `\n   Geplanter Flug: ${flightDate}`;
            }
            
            if (deliveryDate) {
                const deliveryTimeText = (showDeliveryTimes && deliveryTime) ? `, ${deliveryTime} Uhr` : '';
                offerText += `\n   Zustellung: am ${deliveryDate}${deliveryTimeText}`;
            }

            document.getElementById('offer-preview').textContent = offerText;
        }

        function formatGermanDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE');
        }

        function copyToClipboard() {
            const offerText = document.getElementById('offer-preview').textContent;
            
            // Für Outlook formatieren (HTML)
            const htmlText = offerText.replace(/\n/g, '<br>');
            
            // Erstelle ein temporäres Element für HTML-Kopie
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlText;
            document.body.appendChild(tempDiv);
            
            // Kopiere als HTML
            if (window.getSelection) {
                const range = document.createRange();
                range.selectNode(tempDiv);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
            }
            
            document.body.removeChild(tempDiv);
            alert('Angebot wurde für Outlook kopiert (mit Formatierung)!');
        }

        function printOffer() {
            window.print();
        }

        function closeOfferModal() {
            document.getElementById('offerModal').style.display = 'none';
        }

        function editTransport(index) {
            const transport = savedTransports[index];
            
            // Daten in Formular laden
            document.getElementById('transport-name').value = transport.name;
            document.getElementById('transport-group').value = transport.group || 'Sonstiges';
            document.getElementById('transport-priority').value = transport.priority || 1;
            document.getElementById('exchange-rate').value = transport.exchangeRate;
            document.getElementById('shipment-details').value = transport.shipmentDetails || '';
            document.getElementById('origin').value = transport.origin || '';
            document.getElementById('destination').value = transport.destination || '';
            document.getElementById('pickup-date').value = transport.pickupDate || '';
            document.getElementById('pickup-time').value = transport.pickupTime || '11:00';
            document.getElementById('flight-date').value = transport.flightDate || '';
            document.getElementById('delivery-date').value = transport.deliveryDate || '';
            document.getElementById('delivery-time').value = transport.deliveryTime || '';
            document.getElementById('selling-price-input').value = transport.sellingPriceEUR || transport.totalEUR;
            
            // Vorlaufkosten laden
            if (transport.vorlaufkosten) {
                Object.keys(transport.vorlaufkosten).forEach((key, i) => {
                    const cost = transport.vorlaufkosten[key];
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = cost.value || 0;
                        if (document.querySelectorAll('.currency-select')[i]) {
                            document.querySelectorAll('.currency-select')[i].value = cost.currency || 'EUR';
                        }
                    }
                });
            }
            
            // Nachlaufkosten laden
            if (transport.nachlaufkosten) {
                Object.keys(transport.nachlaufkosten).forEach((key, i) => {
                    const cost = transport.nachlaufkosten[key];
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = cost.value || 0;
                        if (document.querySelectorAll('.currency-select')[i + 4]) {
                            document.querySelectorAll('.currency-select')[i + 4].value = cost.currency || 'USD';
                        }
                    }
                });
            }
            
            editingIndex = index;
            document.querySelector('.save-button').textContent = 'Änderungen speichern';
            calculateTotals();
            
            // Scroll zum Formular
            document.querySelector('.calculator-section').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTransport(index) {
            const transportName = savedTransports[index].name;
            if (confirm(`Transport "${transportName}" wirklich löschen?`)) {
                savedTransports.splice(index, 1);
                localStorage.setItem('savedTransports', JSON.stringify(savedTransports));
                displayTransports();
            }
        }

        function clearAllTransports() {
            if (confirm('Wirklich alle Transporte löschen?')) {
                savedTransports = [];
                localStorage.removeItem('savedTransports');
                displayTransports();
            }
        }

        function resetForm() {
            const inputs = document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"], input[type="time"], textarea');
            inputs.forEach(input => input.value = '');
            document.getElementById('exchange-rate').value = '1.18';
            document.getElementById('transport-priority').value = '1';
            document.getElementById('pickup-time').value = '11:00';
            
            // Currency selects zurücksetzen
            document.querySelectorAll('.currency-select').forEach((select, index) => {
                if (index <= 3) {
                    select.value = 'EUR'; // Vorlaufkosten standardmäßig EUR
                } else {
                    select.value = 'USD'; // Nachlaufkosten standardmäßig USD
                }
            });
            
            editingIndex = -1;
            document.querySelector('.save-button').textContent = 'Transport speichern';
            calculateTotals();
        }

        function exportAllToCSV() {
            if (savedTransports.length === 0) {
                alert('Keine Transporte zum Exportieren vorhanden!');
                return;
            }
            
            let csvContent = "Gesamte Transportkostenkalkulation\n\n";
            let grandTotalEKEUR = 0;
            let grandTotalVKEUR = 0;
            
            savedTransports.forEach((transport, index) => {
                csvContent += `Transport ${index + 1}: ${transport.name}\n`;
                csvContent += `Gruppe:,${transport.group}\n`;
                csvContent += `Route:,${transport.origin} → ${transport.destination}\n`;
                csvContent += `Wechselkurs EUR-USD:,${transport.exchangeRate}\n`;
                csvContent += `Datum:,${transport.timestamp}\n`;
                csvContent += `Einkaufspreis:,${transport.totalEUR.toFixed(2)},EUR\n`;
                csvContent += `Verkaufspreis:,${(transport.sellingPriceEUR || transport.totalEUR).toFixed(2)},EUR\n`;
                csvContent += `Gewinn:,${((transport.sellingPriceEUR || transport.totalEUR) - transport.totalEUR).toFixed(2)},EUR\n\n`;
                csvContent += "-------------------\n\n";
                
                grandTotalEKEUR += transport.totalEUR;
                grandTotalVKEUR += transport.sellingPriceEUR || transport.totalEUR;
            });
            
            csvContent += `GESAMTEINKAUFSPREIS,${grandTotalEKEUR.toFixed(2)},EUR\n`;
            csvContent += `GESAMTVERKAUFSPREIS,${grandTotalVKEUR.toFixed(2)},EUR\n`;
            csvContent += `GESAMTGEWINN,${(grandTotalVKEUR - grandTotalEKEUR).toFixed(2)},EUR`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "alle_transportkalkulationen.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event Listener für Modal schließen
        window.onclick = function(event) {
            const modal = document.getElementById('offerModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Initial laden der gespeicherten Transporte
        window.onload = function() {
            displayTransports();
            calculateTotals();
        };
    </script>
</body>
</html>
